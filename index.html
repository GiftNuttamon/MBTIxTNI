<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI x คณะที่ใช่</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* กำหนดรูปแบบหลักของเว็บไซต์ */
        body {
            font-family: 'Mitr', sans-serif;
            overflow: hidden; /* ป้องกันการเลื่อนที่ไม่พึงประสงค์ */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><text y="24" font-size="28" fill="%23b8c2f5">✨</text></svg>') 16 16, auto;
        }
        /* Canvas สำหรับฉาก 3D */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }
        /* รูปแบบการ์ดและปุ่มหลักให้ดูเหมือน "ลูกอมเวทมนตร์" */
        .candy-card {
            background-color: rgba(14, 16, 38, 0.75); /* สีน้ำเงินเข้มโปร่งแสง */
            backdrop-filter: blur(8px);
            border: 2px solid rgba(135, 206, 250, 0.3); /* ขอบฟ้าอ่อน */
            box-shadow: 0 0 30px rgba(135, 206, 250, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .candy-button {
            transition: all 0.3s ease;
            transform: translateZ(0); /* Force GPU acceleration */
            background: linear-gradient(135deg, #a78bfa, #818cf8, #3b82f6);
            box-shadow: 4px 4px 15px rgba(100, 116, 139, 0.7);
        }
        .candy-button:hover {
            transform: scale(1.05) translateZ(0);
            box-shadow: 0 6px 20px rgba(135, 206, 250, 0.8);
        }
        .question-option:hover {
             border-color: #a78bfa;
             box-shadow: 0 0 15px rgba(167, 139, 250, 0.8);
        }
        .glowing-text {
            text-shadow: 0 0 8px #93c5fd, 0 0 15px #60a5fa;
            color: #dbeafe;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <canvas id="three-canvas"></canvas>

    <div id="ui-container" class="relative z-10 p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">
        <header class="fixed top-0 left-0 w-full p-4 flex justify-between items-center z-20">
            <h1 class="text-2xl font-bold glowing-text">MBTI 🔮 MAJOR</h1>
            <div class="flex space-x-2">
                <button onclick="setLanguage('th')" class="text-sm px-3 py-1 rounded-full candy-button hover:bg-blue-600">TH</button>
                <button onclick="setLanguage('en')" class="text-sm px-3 py-1 rounded-full candy-button hover:bg-blue-600">EN</button>
                <button onclick="setLanguage('ja')" class="text-sm px-3 py-1 rounded-full candy-button hover:bg-blue-600">JP</button>
            </div>
        </header>

        <div id="main-card" class="candy-card w-full max-w-lg p-6 sm:p-10 rounded-3xl mt-20 mb-10 overflow-auto max-h-[90vh]">
            <div id="step-1" class="step-screen">
                <h2 class="text-3xl font-extrabold mb-6 text-center glowing-text" data-lang-key="title-start">เลือกคณะให้ตรงใจ MBT(N)I x คณะที่ใช่</h2>
                <div class="space-y-4">
                    <label class="block">
                        <span class="glowing-text" data-lang-key="label-name">ชื่อเล่น (Nickname):</span>
                        <input type="text" id="user-name" class="w-full mt-1 p-3 rounded-xl bg-gray-800 border border-purple-500 focus:ring-blue-500 focus:border-blue-500 text-lg" required>
                    </label>
                    <label class="block">
                        <span class="glowing-text" data-lang-key="label-age">อายุ (Age):</span>
                        <input type="number" id="user-age" class="w-full mt-1 p-3 rounded-xl bg-gray-800 border border-purple-500 focus:ring-blue-500 focus:border-blue-500 text-lg" min="10" max="99" required>
                    </label>
                    <div class="block">
                        <span class="glowing-text" data-lang-key="label-gender">เพศ (Gender):</span>
                        <div class="mt-2 flex space-x-4">
                            <button onclick="setGender('Male')" class="gender-button flex-1 p-3 rounded-xl bg-gray-700 hover:bg-blue-600 border border-transparent transition duration-200 text-lg" data-gender="Male" data-lang-key="gender-male">ชาย (Male)</button>
                            <button onclick="setGender('Female')" class="gender-button flex-1 p-3 rounded-xl bg-gray-700 hover:bg-pink-600 border border-transparent transition duration-200 text-lg" data-gender="Female" data-lang-key="gender-female">หญิง (Female)</button>
                        </div>
                    </div>
                </div>
                <button onclick="startQuiz()" id="start-button" class="candy-button w-full mt-8 p-4 rounded-full text-xl font-bold hover:brightness-110" data-lang-key="button-start" disabled>เริ่มต้นการเดินทาง</button>
            </div>

            <div id="step-2" class="step-screen hidden">
                <h2 class="text-3xl font-extrabold mb-8 text-center glowing-text" data-lang-key="title-quiz">ค้นพบตัวตน: แบบทดสอบบุคลิกภาพ</h2>
                <div id="quiz-content">
                    </div>
                <div class="flex justify-between items-center mt-6">
                    <p class="glowing-text" data-lang-key="progress-text">คำถามที่ <span id="current-q">1</span> จาก 12</p>
                    <button onclick="nextQuestion()" id="next-q-button" class="candy-button p-3 rounded-full text-lg font-bold hover:brightness-110" data-lang-key="button-next" disabled>ต่อไป</button>
                </div>
            </div>

            <div id="step-3" class="step-screen hidden text-center">
    <h2 class="text-3xl font-extrabold mb-4 glowing-text" data-lang-key="title-result">ยินดีด้วย! คุณคือ...</h2>
    <p id="result-mbti" class="text-6xl font-black text-yellow-300 glowing-text mb-6"></p>

    <div id="recommendation-box" class="p-6 rounded-2xl bg-gray-800 border border-blue-500 text-left">
        <p class="text-xl font-semibold glowing-text mb-2" data-lang-key="label-major">คณะที่เหมาะสมสำหรับคุณ:</p>
        <p id="result-major" class="text-2xl font-bold text-teal-400 mb-4"></p>
        <p class="text-xl font-semibold glowing-text mb-2" data-lang-key="label-reason">เหตุผล:</p>
        <p id="result-reason" class="text-lg"></p>
    </div>

    <div id="animation-placeholder" class="mt-8">
        <div id="npc-door-animation" class="mt-4 flex flex-col items-center justify-center">
            <div id="npc-info" class="mb-2 p-2 bg-purple-900/50 rounded-xl text-sm glowing-text"></div>
            <div id="npc-icon" class="text-5xl mb-4 animate-bounce"></div>
            <div class="w-full max-w-xs h-10 bg-gradient-to-r from-teal-400/20 via-teal-400/80 to-teal-400/20 rounded-full shadow-lg shadow-teal-500/50 flex items-center justify-center">
                <span class="sm-font-bold text-gray-900" id="door-label"></span>
            </div>
        </div>
    </div>
    
    <button id="detailbt" onclick="showMajorDetails()" class="candy-button w-full mt-8 p-4 rounded-full text-xl font-bold hover:brightness-110" data-lang-key="button-details">ดูรายละเอียด MBTI ทั้งหมด</button>
    
    <button id="sharebt" onclick="shareResult()" class="candy-button w-full mt-4 p-4 rounded-full text-xl font-bold bg-blue-600 hover:bg-blue-700" data-lang-key="button-share">แชร์ผลลัพธ์</button>

</div>

            <div id="step-4" class="step-screen hidden">
                <h2 class="text-3xl font-extrabold mb-6 text-center glowing-text" data-lang-key="title-details">MBTI และคณะทั้งหมด: โลกแห่งความรู้</h2>

                <div id="major-list" class="space-y-8">
                    </div>
                <button onclick="resetApp()" class="candy-button w-full mt-8 p-4 rounded-full text-xl font-bold bg-red-600 hover:bg-red-700" data-lang-key="button-reset">เริ่มใหม่</button>
            </div>
            <video style="margin-top: 10%; margin-bottom: 20%;" autoplay muted loop class="w-full rounded-2xl mb-6">
                <source src="video/MB(T)NI x คณะที่ใช่.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <div id="message-box" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden candy-card p-6 rounded-2xl text-center z-50">
            <p id="message-text" class="text-xl font-semibold mb-4"></p>
            <button onclick="hideMessage()" class="candy-button px-6 py-2 rounded-full font-bold">OK</button>
        </div>

    </div>
    
    <div id="share-popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
        <div class="candy-card w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 class="text-2xl font-bold glowing-text mb-4">แชร์ผลลัพธ์ของคุณ!</h3>
            <div id="screenshot-preview-container" class="mb-4">
                <img id="screenshot-preview" class="w-full h-auto rounded-lg border-2 border-purple-500">
            </div>

            

            <div class="flex space-x-4 justify-center mt-4">
    <!-- Instagram -->
    <a id="ig-story-share-button" 
       class="candy-button w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-tr from-yellow-400 via-pink-500 to-purple-600 hover:opacity-80" 
       href="#">
        <i class="fab fa-instagram text-white text-2xl"></i>
    </a>

    <!-- Facebook -->
    <a id="fb-share-button" 
       class="candy-button w-14 h-14 flex items-center justify-center rounded-full bg-blue-600 hover:bg-blue-700" 
       href="#">
        <i class="fab fa-facebook-f text-white text-2xl"></i>
    </a>

    <!-- Cancel -->
    <button onclick="hideSharePopup()" 
            class="candy-button w-14 h-14 flex items-center justify-center rounded-full bg-red-600 hover:bg-red-700">
        <i class="fas fa-times text-white text-2xl"></i>
    </button>
</div>



        </div>
    </div>


    <script>
        // GLOBAL VARIABLES
        let currentStep = 1;
        let userName = '';
        let userAge = 0;
        let userGender = '';
        let currentQuestionIndex = 0;
        let score = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        let currentLanguage = 'th'; // Default language

        // Three.js Variables
        let scene, camera, renderer, magicObjects = [];
        const NPC_MAPPING = {
            INTJ: { icon: '🦉', color: '#9d174d' }, // Owl
            ENTJ: { icon: '🦁', color: '#f59e0b' }, // Lion
            INTP: { icon: '🦊', color: '#10b981' }, // Fox
            ISTP: { icon: '🛠️', color: '#f97316' }, // Tool/Maker
            ENTP: { icon: '🦎', color: '#8b5cf6' }, // Chameleon
            INFJ: { icon: '🦄', color: '#ec4899' }, // Unicorn
            ISFP: { icon: '🎨', color: '#ef4444' }, // Artist/Palette
            ESTJ: { icon: '🦫', color: '#14b8a6' }, // Beaver
            ISTJ: { icon: '🐜', color: '#3b82f6' }, // Ant
            ESFJ: { icon: '🐕', color: '#fcd34d' }, // Dog
            ENFJ: { icon: '🐬', color: '#06b6d4' }, // Dolphin
            ENFP: { icon: '🐒', color: '#f472b6' }, // Monkey
            default: { icon: '✨', color: '#fef3c7' }
        };


        // --- TRANSLATION DATA ---
        const translations = {
            'th': {
                'title-start': 'เลือกคณะให้ตรงใจ MBT(N)I x คณะที่ใช่',
                'label-name': 'ชื่อเล่น (Nickname):',
                'label-age': 'อายุ (Age):',
                'label-gender': 'เพศ (Gender):',
                'gender-male': 'ชาย (Male)',
                'gender-female': 'หญิง (Female)',
                'button-start': 'เริ่มต้นการเดินทาง',
                'title-quiz': 'ค้นพบตัวตน: แบบทดสอบบุคลิกภาพ',
                'progress-text': 'คำถามที่ <span id="current-q">1</span> จาก 12',
                'button-next': 'ต่อไป',
                'title-result': 'ยินดีด้วย! คุณคือ...',
                'label-major': 'คณะที่เหมาะสมสำหรับคุณ:',
                'label-reason': 'เหตุผล:',
                'animation-hint': 'ตัวละครของคุณกำลังเดินทางเข้าสู่ประตูวิชาเอกแล้ว...',
                'button-details': 'ดูรายละเอียด MBTI ทั้งหมด',
                'button-share': 'แชร์ผลลัพธ์',
                'title-details': 'MBTI และคณะทั้งหมด: โลกแห่งความรู้',
                'button-reset': 'เริ่มใหม่',
                'alert-fill-all': 'กรุณากรอกข้อมูลให้ครบถ้วนก่อนเริ่มต้น',
                'alert-select-option': 'กรุณาเลือกคำตอบก่อนไปต่อ',
                'q1': { text: 'เมื่อคุณต้องเติมพลัง คุณชอบ...', a: { score: 'E', text: 'ไปปาร์ตี้, พบปะผู้คน' }, b: { score: 'I', text: 'อยู่เงียบ ๆ, อ่านหนังสือคนเดียว' } },
                'q2': { text: 'คุณมักตัดสินใจโดย...', a: { score: 'T', text: 'ใช้หลักเหตุผลและตรรกะ' }, b: { score: 'F', text: 'ใช้ความรู้สึกและค่านิยมส่วนตัว' } },
                'q3': { text: 'ในการทำงาน คุณชอบ...', a: { score: 'J', text: 'วางแผนล่วงหน้าและจัดระเบียบ' }, b: { score: 'P', text: 'ยืดหยุ่น ปรับเปลี่ยนตามสถานการณ์' } },
                'q4': { text: 'คุณให้ความสำคัญกับ...', a: { score: 'S', text: 'รายละเอียด ข้อมูลที่เป็นจริง' }, b: { score: 'N', text: 'ภาพรวม แนวคิดนามธรรม' } },
                'q5': { text: 'เมื่อต้องทำงาน คุณรู้สึกตื่นเต้นกับ...', a: { score: 'E', text: 'การทำงานร่วมกับทีมขนาดใหญ่' }, b: { score: 'I', text: 'การทำงานอิสระด้วยตัวเอง' } },
                'q6': { text: 'ในการสื่อสาร คุณชอบ...', a: { score: 'T', text: 'ความตรงไปตรงมา เน้นประสิทธิภาพ' }, b: { score: 'F', text: 'รักษาน้ำใจและความสามัคคี' } },
                'q7': { text: 'คุณมองกำหนดเวลาเป็น...', a: { score: 'J', text: 'สิ่งที่ต้องทำตามอย่างเคร่งครัด' }, b: { score: 'P', text: 'แนวทางที่ปรับเปลี่ยนได้เสมอ' } },
                'q8': { text: 'คุณมีแนวโน้มที่จะ...', a: { score: 'S', text: 'เชื่อสิ่งที่พิสูจน์ได้ด้วยประสาทสัมผัส' }, b: { score: 'N', text: 'ชอบจินตนาการถึงความเป็นไปได้' } },
                'q9': { text: 'วันหยุดพักผ่อนที่ดีที่สุดคือ...', a: { score: 'E', text: 'ไปเที่ยวกับเพื่อน ๆ' }, b: { score: 'I', text: 'ดูหนังอยู่บ้านคนเดียว' } },
                'q10': { text: 'เมื่อเพื่อนมีปัญหา คุณ...', a: { score: 'T', text: 'ให้คำแนะนำเชิงตรรกะในการแก้ปัญหา' }, b: { score: 'F', text: 'รับฟังและแสดงความเห็นใจ' } },
                'q11': { text: 'คุณชอบที่จะ...', a: { score: 'J', text: 'มีตารางเวลาในแต่ละวัน' }, b: { score: 'P', text: 'ใช้ชีวิตแบบสบาย ๆ ไม่กำหนดอะไรมาก' } },
                'q12': { text: 'คุณมักจะ...', a: { score: 'S', text: 'มุ่งเน้นที่ปัจจุบันและสิ่งที่กำลังทำอยู่' }, b: { score: 'N', text: 'วาดฝันถึงอนาคตอันไกลโพ้น' } },
                'major-eng': 'คณะวิศวกรรมศาสตร์',
                'major-it': 'คณะเทคโนโลยีสารสนเทศ',
                'major-bba': 'คณะบริหารธุรกิจ',
                'major-comm': 'คณะสื่อสารสากล',
                'major-indtech': 'คณะเทคโนโลยีดิจิทัลเพื่อธุรกิจอุตสาหกรรม',
                // descriptions (for step 4 cards)
                major_desc: {
                    eng: 'เหมาะกับคนที่ชอบคิดวิเคราะห์ แก้ปัญหา และสร้างนวัตกรรมใหม่ๆ',
                    it: 'เหมาะกับคนที่สนใจเทคโนโลยี นวัตกรรมดิจิทัล และการวิเคราะห์ข้อมูล',
                    bba: 'เหมาะกับคนที่สนใจการนำเทคโนโลยีดิจิทัล มาใช้ในภาคธุรกิจ',
                    comm: 'เหมาะกับคนที่รักการสื่อสาร และสนใจเรื่องภาษาวัฒนธรรม',
                    indtech: 'เหมาะกับคนที่สนใจการนำเทคโนโลยีดิจิทัลมาใช้ในภาคอุตสาหกรรม'
                },
                reasoning: {
                    eng: {
                        INTJ: 'นักวางแผนกลยุทธ์และพัฒนาเทคโนโลยี ที่สามารถออกแบบโครงสร้างที่ซับซ้อนได้อย่างมีประสิทธิภาพ',
                        ENTJ: 'ผู้นำที่ต้องการควบคุมและบริหารระบบ มีวิสัยทัศน์ในการนำโครงการวิศวกรรมขนาดใหญ่',
                        INTP: 'นักคิดนอกกรอบ ชอบทดลองและพัฒนา มีความสนใจในการค้นคว้าหลักการทางฟิสิกส์และคณิตศาสตร์',
                        ISTP: 'นักลงมือทำ ชอบประกอบและทดลองเครื่องจักร มีทักษะการแก้ปัญหาในทางปฏิบัติได้อย่างรวดเร็ว'
                    },
                    it: {
                        INTP: 'นักคิดเชิงวิเคราะห์ ชอบออกแบบระบบ มีความเข้าใจในโครงสร้างข้อมูลและอัลกอริทึม',
                        ENTP: 'คนที่ชอบพัฒนาเทคโนโลยีใหม่ๆ และสร้างสรรค์โซลูชันด้านดิจิทัลที่ไม่เหมือนใคร',
                        INFJ: 'อยากใช้เทคโนโลยีเพื่อช่วยเหลือสังคม มีแรงขับเคลื่อนในการสร้างแอปที่มีความหมาย',
                        ISFP: 'โดดเด่นด้านงานออกแบบดิจิทัล UI/UX และการสร้างประสบการณ์ผู้ใช้'
                    },
                    bba: {
                        ESTJ: 'นักบริหารที่มีระบบระเบียบ วางแผนการตลาดและการดำเนินงานได้อย่างเป็นขั้นตอน',
                        ISTJ: 'นักวางแผนและจัดการธุรกิจ ที่แม่นยำและรอบคอบในตัวเลขการเงิน',
                        ESFJ: 'มนุษย์สัมพันธ์ดี รักงานบริการ และสร้างเครือข่ายลูกค้าได้',
                        ENFJ: 'ผู้นำที่เข้าใจคน กระตุ้นทีมให้บรรลุเป้าหมายทางธุรกิจ',
                        ENFP: 'นักสร้างสรรค์ไอเดียใหม่ๆ มีความคิดริเริ่ม ทำแคมเปญดึงดูด'
                    },
                    comm: {
                        ENFP: 'นักเล่าเรื่องสร้างแรงบันดาลใจ ถ่ายทอดข้อความทรงพลังและน่าจดจำ',
                        ENTP: 'นักคิดนอกกรอบ เก่งเจรจาและพรีเซนต์ โน้มน้าวใจผู้อื่น',
                        INFJ: 'นักสื่อสารเพื่อการเปลี่ยนแปลงสังคม ใช้คำพูดสร้างความเข้าใจ',
                        ENFJ: 'นักพูดมีเสน่ห์ สร้างอิทธิพล ดึงดูดผู้ฟัง'
                    },
                    indtech: {
                        INTJ: 'นักวางแผนกลยุทธ์และพัฒนาเทคโนโลยี สร้างระบบอัตโนมัติในโรงงาน',
                        ENTJ: 'ผู้นำที่บริหารเทคโนโลยีอุตสาหกรรม ควบคุมซัพพลายเชน',
                        ISTJ: 'นักวิเคราะห์ข้อมูลที่แม่นยำ ใช้ข้อมูลเพิ่มประสิทธิภาพการผลิต',
                        INTP: 'นักคิดเชิงวิเคราะห์ ชอบออกแบบ/พัฒนาเทคโนโลยีใหม่ เช่น IoT และ AI'
                    }
                },
                reasoning_generic: {
                    eng: 'บุคลิกของคุณเหมาะกับการคิดวิเคราะห์และแก้ปัญหาเชิงโครงสร้าง',
                    it: 'บุคลิกของคุณเหมาะกับการสำรวจแนวคิดใหม่และการพัฒนาดิจิทัล',
                    bba: 'บุคลิกของคุณเหมาะกับงานด้านธุรกิจและการประสานงาน',
                    comm: 'บุคลิกของคุณเหมาะกับการสื่อสารและสร้างแรงบันดาลใจ',
                    indtech: 'บุคลิกของคุณเหมาะกับการประยุกต์เทคโนโลยีในอุตสาหกรรม'
                },
                fallbacks: {
                    TJ: 'บุคลิกของคุณเหมาะกับการวางแผนและแก้ปัญหาเชิงโครงสร้าง (Fallback)',
                    NP: 'บุคลิกของคุณเหมาะกับการสำรวจแนวคิดใหม่ ๆ และการพัฒนาดิจิทัล (Fallback)',
                    FE: 'บุคลิกของคุณเหมาะกับการสื่อสาร สร้างแรงบันดาลใจ และการสร้างความสัมพันธ์ (Fallback)',
                    DEFAULT_BBA: 'บุคลิกของคุณมีความสามารถในการปรับตัวได้ดีกับสายงานธุรกิจ (Default Fallback)'
                }
            },
            'en': {
                'title-start': 'Find Your Path: MBT(N)I x Major',
                'label-name': 'Nickname:',
                'label-age': 'Age:',
                'label-gender': 'Gender:',
                'gender-male': 'Male',
                'gender-female': 'Female',
                'button-start': 'Start the Journey',
                'title-quiz': 'Discover Yourself: Personality Quiz',
                'progress-text': 'Question <span id="current-q">1</span> of 12',
                'button-next': 'Next',
                'title-result': 'Congratulations! You are...',
                'label-major': 'Your Recommended Major:',
                'label-reason': 'Reasoning:',
                'animation-hint': 'Your character is walking towards the Major Door...',
                'button-details': 'View All MBTI Details',
                'button-share': 'Share Your Result',
                'title-details': 'All MBTIs and Majors: World of Knowledge',
                'button-reset': 'Start Over',
                'alert-fill-all': 'Please fill in all information before starting.',
                'alert-select-option': 'Please select an answer before proceeding.',
                'q1': { text: 'When recharging, you prefer to...', a: { score: 'E', text: 'Go to a party, meet people' }, b: { score: 'I', text: 'Be quiet, read alone' } },
                'q2': { text: 'You usually make decisions by...', a: { score: 'T', text: 'Using logic and reason' }, b: { score: 'F', text: 'Using feelings and personal values' } },
                'q3': { text: 'In your work, you like to...', a: { score: 'J', text: 'Plan ahead and organize' }, b: { score: 'P', text: 'Be flexible, change according to the situation' } },
                'q4': { text: 'You prioritize...', a: { score: 'S', text: 'Details, concrete facts' }, b: { score: 'N', text: 'The big picture, abstract concepts' } },
                'q5': { text: 'When working, you are excited by...', a: { score: 'E', text: 'Collaborating with a large team' }, b: { score: 'I', text: 'Working independently by yourself' } },
                'q6': { text: 'In communication, you prefer...', a: { score: 'T', text: 'Directness, focusing on efficiency' }, b: { score: 'F', text: 'Maintaining harmony and saving face' } },
                'q7': { text: 'You see deadlines as...', a: { score: 'J', text: 'Something to strictly adhere to' }, b: { score: 'P', text: 'A guideline that can always be adjusted' } },
                'q8': { text: 'You tend to...', a: { score: 'S', text: 'Believe what can be proven by the senses' }, b: { score: 'N', text: 'Like imagining possibilities' } },
                'q9': { text: 'The best vacation is...', a: { score: 'E', text: 'Traveling with friends' }, b: { score: 'I', text: 'Watching a movie at home alone' } },
                'q10': { text: 'When a friend has a problem, you...', a: { score: 'T', text: 'Give logical advice for solving the problem' }, b: { score: 'F', text: 'Listen and express sympathy' } },
                'q11': { text: 'You like to...', a: { score: 'J', text: 'Have a daily schedule' }, b: { score: 'P', text: 'Live a casual life without much structure' } },
                'q12': { text: 'You usually...', a: { score: 'S', text: 'Focus on the present and what you are doing' }, b: { score: 'N', text: 'Dream of the distant future' } },
                'major-eng': 'Faculty of Engineering',
                'major-it': 'Faculty of Information Technology',
                'major-bba': 'Faculty of Business Administration',
                'major-comm': 'Faculty of Global Communication',
                'major-indtech': 'Faculty of Digital Technology for Industrial Business',
                major_desc: {
                    eng: 'Best for analytical problem-solvers who love building new innovations.',
                    it: 'Great for tech-curious minds into digital innovation and data analysis.',
                    bba: 'Ideal for those who want to apply digital tech in business.',
                    comm: 'For communicators who are passionate about language and culture.',
                    indtech: 'For those who want to apply digital tech in industrial settings.'
                },
                reasoning: {
                    eng: {
                        INTJ: 'A strategic planner who designs efficient, complex systems.',
                        ENTJ: 'A visionary leader who can manage large-scale engineering projects.',
                        INTP: 'An out-of-the-box thinker who loves research in physics and math.',
                        ISTP: 'A hands-on builder who rapidly solves practical problems.'
                    },
                    it: {
                        INTP: 'An analytical thinker who enjoys system design and algorithms.',
                        ENTP: 'An innovator who creates unique digital solutions.',
                        INFJ: 'Driven to build meaningful apps that help society.',
                        ISFP: 'Creative in digital design with strengths in UI/UX and user experience.'
                    },
                    bba: {
                        ESTJ: 'A structured manager who plans marketing and operations step by step.',
                        ISTJ: 'A precise business planner with solid financial analysis.',
                        ESFJ: 'Service-minded with strong relationships and customer networks.',
                        ENFJ: 'An inspiring leader who motivates teams to hit business goals.',
                        ENFP: 'A creative trendsetter who crafts engaging campaigns.'
                    },
                    comm: {
                        ENFP: 'A storyteller who inspires with memorable, powerful messages.',
                        ENTP: 'A persuasive negotiator and presenter who convinces others.',
                        INFJ: 'A communicator who seeks social change and understanding.',
                        ENFJ: 'A charismatic speaker who influences and captivates audiences.'
                    },
                    indtech: {
                        INTJ: 'A strategist who builds factory automation systems.',
                        ENTJ: 'A leader managing industrial technology and supply chains.',
                        ISTJ: 'A precise analyst who boosts production efficiency with data.',
                        INTP: 'An analytical builder of new tech like IoT and AI for factories.'
                    }
                },
                reasoning_generic: {
                    eng: 'Your profile fits structured, analytical problem-solving.',
                    it: 'Your profile fits exploring new ideas and digital development.',
                    bba: 'Your profile fits business, coordination, and adaptability.',
                    comm: 'Your profile fits communication and inspiring others.',
                    indtech: 'Your profile fits applying technology to industry.'
                },
                fallbacks: {
                    TJ: 'Your profile suits planning and solving structured problems (Fallback).',
                    NP: 'Your profile suits exploring new ideas and digital development (Fallback).',
                    FE: 'Your profile suits communication, inspiration, and relationships (Fallback).',
                    DEFAULT_BBA: 'Your profile adapts well to business roles (Default Fallback).'
                }
            },
            'ja': {
                'title-start': '夢の専攻を見つけよう: MBT(N)I x 専攻',
                'label-name': 'ニックネーム (Nickname):',
                'label-age': '年齢 (Age):',
                'label-gender': '性別 (Gender):',
                'gender-male': '男性 (Male)',
                'gender-female': '女性 (Female)',
                'button-start': '旅を始める',
                'title-quiz': '自己発見: 性格診断クイズ',
                'progress-text': '質問 <span id="current-q">1</span> / 12',
                'button-next': '次へ',
                'title-result': 'おめでとうございます！あなたは...',
                'label-major': 'あなたに推奨される専攻:',
                'label-reason': '理由:',
                'animation-hint': 'あなたのキャラクターは専攻の扉に向かって歩いています...',
                'button-details': 'MBTIの詳細をすべて見る',
                'button-share': '結果を共有する',
                'title-details': 'すべてのMBTIと専攻: 知識の世界',
                'button-reset': '最初から',
                'alert-fill-all': '開始する前に入力欄をすべてご記入ください。',
                'alert-select-option': '次に進む前に回答を選択してください。',
                'q1': { text: 'エネルギーをチャージしたいとき、あなたは...', a: { score: 'E', text: 'パーティーに行く、人と会う' }, b: { score: 'I', text: '静かに過ごす、一人で読書する' } },
                'q2': { text: 'あなたは通常、どのように決断しますか？', a: { score: 'T', text: '論理と理性を利用する' }, b: { score: 'F', text: '感情と個人的な価値観を利用する' } },
                'q3': { text: '仕事では、あなたは...', a: { score: 'J', text: '事前に計画を立てて整理する' }, b: { score: 'P', text: '柔軟に対応し、状況に応じて変更する' } },
                'q4': { text: 'あなたが優先するのは...', a: { score: 'S', text: '詳細、具体的な事実' }, b: { score: 'N', text: '全体像、抽象的な概念' } },
                'q5': { text: '働くとき、あなたがわくわくするのは...', a: { score: 'E', text: '大きなチームと協力すること' }, b: { score: 'I', text: '一人で独立して作業すること' } },
                'q6': { text: 'コミュニケーションでは、あなたは...', a: { score: 'T', text: '率直さ、効率性に焦点を当てる' }, b: { score: 'F', text: '調和を保ち、相手の気持ちを尊重する' } },
                'q7': { text: '締め切りをどのように考えますか？', a: { score: 'J', text: '厳守すべきもの' }, b: { score: 'P', text: 'いつでも調整可能なガイドライン' } },
                'q8': { text: 'あなたは次の傾向があります...', a: { score: 'S', text: '五感で証明できることを信じる' }, b: { score: 'N', text: '可能性を想像するのが好き' } },
                'q9': { text: '最高の休暇は...', a: { score: 'E', text: '友達と旅行に行く' }, b: { score: 'I', text: '一人で家で映画を見る' } },
                'q10': { text: '友達が問題を抱えているとき、あなたは...', a: { score: 'T', text: '論理的なアドバイスを与える' }, b: { score: 'F', text: '共感して話を聞く' } },
                'q11': { text: 'あなたはどちらかというと...', a: { score: 'J', text: '毎日のスケジュールを持つ' }, b: { score: 'P', text: '気楽に予定を決めずに過ごす' } },
                'q12': { text: 'あなたは普段...', a: { score: 'S', text: '現在とやっていることに集中する' }, b: { score: 'N', text: '遠い未来を夢見る' } },
                'major-eng': '工学部',
                'major-it': '情報技術学部',
                'major-bba': '経営管理学部',
                'major-comm': 'グローバルコミュニケーション学部',
                'major-indtech': '産業ビジネス向けデジタル技術学部',
                major_desc: {
                    eng: '分析と思考で問題解決し、革新的なものづくりが好きな人に最適。',
                    it: 'デジタル革新とデータ分析に興味がある人に最適。',
                    bba: 'デジタル技術をビジネスに応用したい人に最適。',
                    comm: '言語や文化に情熱があるコミュニケーター向け。',
                    indtech: 'デジタル技術を産業現場に応用したい人に最適。'
                },
                reasoning: {
                    eng: {
                        INTJ: '効率的で複雑なシステムを設計できる戦略的プランナー。',
                        ENTJ: '大規模な工学プロジェクトを牽引できるビジョナリーなリーダー。',
                        INTP: '物理や数学の探究を好む、独創的な研究志向の思考家。',
                        ISTP: '実践的な課題を素早く解決する、手を動かす職人肌。'
                    },
                    it: {
                        INTP: 'システム設計やアルゴリズムを楽しむ分析的思考者。',
                        ENTP: '独自のデジタル解決策を生み出すイノベーター。',
                        INFJ: '社会に役立つ有意義なアプリを作りたいという動機が強い。',
                        ISFP: 'UI/UXなどデジタルデザインに強みを持つクリエイティブ。'
                    },
                    bba: {
                        ESTJ: '段階的にマーケとオペレーションを計画できる規律あるマネージャー。',
                        ISTJ: '正確な数値分析でビジネスを設計する堅実なプランナー。',
                        ESFJ: '顧客関係とネットワーク構築に秀でたサービス志向。',
                        ENFJ: 'チームを鼓舞し目標達成へ導くインスピレーショナルなリーダー。',
                        ENFP: '魅力的なキャンペーンを生み出す発想力豊かなクリエイター。'
                    },
                    comm: {
                        ENFP: '心に残るメッセージで人を動かすストーリーテラー。',
                        ENTP: '交渉・プレゼンに長け、人の心を動かす説得力がある。',
                        INFJ: '社会課題に向き合い理解を広げるコミュニケーター。',
                        ENFJ: 'カリスマ性あるスピーカーで聴衆を魅了する。'
                    },
                    indtech: {
                        INTJ: '工場自動化システムを設計する戦略家。',
                        ENTJ: '産業テクノロジーとサプライチェーンを統率するリーダー。',
                        ISTJ: 'データで生産効率を高める精緻なアナリスト。',
                        INTP: 'IoTやAIなど新技術を工場へ応用する分析的開発者。'
                    }
                },
                reasoning_generic: {
                    eng: 'あなたの特性は構造的な課題解決に適しています。',
                    it: 'あなたの特性は新しいアイデア探求とデジタル開発に適しています。',
                    bba: 'あなたの特性はビジネスや調整業務に適しています。',
                    comm: 'あなたの特性はコミュニケーションと人を鼓舞することに適しています。',
                    indtech: 'あなたの特性は産業への技術応用に適しています。'
                },
                fallbacks: {
                    TJ: 'あなたの特性は計画と構造的な問題解決に適しています（Fallback）。',
                    NP: 'あなたの特性は新しいアイデア探求とデジタル開発に適しています（Fallback）。',
                    FE: 'あなたの特性はコミュニケーションと人間関係構築に適しています（Fallback）。',
                    DEFAULT_BBA: 'あなたの特性はビジネス分野に柔軟に適応できます（Default Fallback）。'
                }
            }
        };

        // --- QUIZ QUESTIONS ---
        const quizQuestions = [
            { key: 'q1', type: 'EI' }, { key: 'q2', type: 'TF' }, { key: 'q3', type: 'JP' },
            { key: 'q4', type: 'SN' }, { key: 'q5', type: 'EI' }, { key: 'q6', type: 'TF' },
            { key: 'q7', type: 'JP' }, { key: 'q8', type: 'SN' }, { key: 'q9', type: 'EI' },
            { key: 'q10', type: 'TF' }, { key: 'q11', type: 'JP' }, { key: 'q12', type: 'SN' }
        ];

        // --- MAJOR DATA & LOGIC ---
        const majorData = [
            {
                id: 'eng', lang_key: 'major-eng',
                description: 'เหมาะกับคนที่ชอบคิดวิเคราะห์ แก้ปัญหา และสร้างนวัตกรรมใหม่ๆ',
                mbti: ['INTJ', 'ENTJ', 'INTP', 'ISTP'],
                reasoning: {
                    INTJ: 'นักวางแผนกลยุทธ์และพัฒนาเทคโนโลยี ที่สามารถออกแบบโครงสร้างที่ซับซ้อนได้อย่างมีประสิทธิภาพ',
                    ENTJ: 'ผู้นำที่ต้องการควบคุมและบริหารระบบ มีวิสัยทัศน์ในการนำโครงการวิศวกรรมขนาดใหญ่',
                    INTP: 'นักคิดนอกกรอบ ชอบทดลองและพัฒนา มีความสนใจในการค้นคว้าหลักการทางฟิสิกส์และคณิตศาสตร์',
                    ISTP: 'นักลงมือทำ ชอบประกอบและทดลองเครื่องจักร มีทักษะการแก้ปัญหาในทางปฏิบัติได้อย่างรวดเร็ว',
                }
            },
            {
                id: 'it', lang_key: 'major-it',
                description: 'เหมาะกับคนที่สนใจเทคโนโลยี นวัตกรรมดิจิทัล และการวิเคราะห์ข้อมูล',
                mbti: ['INTP', 'ENTP', 'INFJ', 'ISFP'],
                reasoning: {
                    INTP: 'นักคิดเชิงวิเคราะห์ ชอบออกแบบระบบ มีความเข้าใจในโครงสร้างข้อมูลและอัลกอริทึม',
                    ENTP: 'คนที่ชอบพัฒนาเทคโนโลยีใหม่ๆ และสร้างสรรค์โซลูชันด้านดิจิทัลที่ไม่เหมือนใคร',
                    INFJ: 'คนที่อยากใช้เทคโนโลยีเพื่อช่วยเหลือสังคม มีแรงขับเคลื่อนในการสร้างแอปพลิเคชันที่มีความหมาย',
                    ISFP: 'คนที่มีความคิดสร้างสรรค์ด้านงานออกแบบดิจิทัล โดดเด่นด้าน UI/UX และการสร้างประสบการณ์ผู้ใช้',
                }
            },
            {
                id: 'bba', lang_key: 'major-bba',
                description: 'เหมาะกับคนที่สนใจการนำเทคโนโลยีดิจิทัล มาใช้ในภาคธุรกิจ',
                mbti: ['ESTJ', 'ISTJ', 'ESFJ', 'ENFJ', 'ENFP'],
                reasoning: {
                    ESTJ: 'นักบริหารที่มีระบบระเบียบ สามารถวางแผนการตลาดและการดำเนินงานได้อย่างเป็นขั้นตอน',
                    ISTJ: 'นักวางแผนและจัดการธุรกิจ ที่มีความแม่นยำและรอบคอบในการวิเคราะห์ตัวเลขทางการเงิน',
                    ESFJ: 'คนที่มีมนุษย์สัมพันธ์ดีรักงานบริการ มีทักษะในการสร้างเครือข่ายและความสัมพันธ์ที่ดีกับลูกค้า',
                    ENFJ: 'นักสร้างแรงบันดาลใจและผู้นำที่เข้าใจคน สามารถกระตุ้นทีมงานให้บรรลุเป้าหมายทางธุรกิจ',
                    ENFP: 'นักสร้างสรรค์ไอเดียใหม่ๆ ด้านธุรกิจ มีความคิดริเริ่มและสามารถสร้างแคมเปญที่น่าดึงดูด',
                }
            },
            {
                id: 'comm', lang_key: 'major-comm',
                description: 'เหมาะกับคนที่รักการสื่อสาร และสนใจเรื่องภาษาวัฒนธรรม',
                mbti: ['ENFP', 'ENTP', 'INFJ', 'ENFJ'],
                reasoning: {
                    ENFP: 'นักเล่าเรื่องสร้างแรงบันดาลใจ สามารถถ่ายทอดข้อความที่ทรงพลังและน่าจดจำ',
                    ENTP: 'นักคิดนอกกรอบ เก่งด้านการเจรจาและนำเสนอ มีความสามารถในการโน้มน้าวใจผู้อื่น',
                    INFJ: 'นักสื่อสารที่ต้องการเปลี่ยนแปลงสังคม ใช้คำพูดเพื่อสร้างความเข้าใจในประเด็นสำคัญ',
                    ENFJ: 'นักพูด นักสร้างอิทธิพล และคนที่มีเสน่ห์ในการสื่อสาร มีความสามารถในการดึงดูดผู้ฟัง',
                }
            },
            {
                id: 'indtech', lang_key: 'major-indtech',
                description: 'เหมาะกับคนที่สนใจการนำเทคโนโลยีดิจิทัลมาใช้ในภาคอุตสาหกรรม',
                mbti: ['INTJ', 'ENTJ', 'ISTJ', 'INTP'],
                reasoning: {
                    INTJ: 'นักวางแผนกลยุทธ์และพัฒนาเทคโนโลยี สามารถสร้างระบบอัตโนมัติในโรงงานอุตสาหกรรม',
                    ENTJ: 'ผู้นำที่ชอบบริหารจัดการเทคโนโลยีระบบอุตสาหกรรม มีความสามารถในการควบคุมห่วงโซ่อุปทาน',
                    ISTJ: 'นักวิเคราะห์ข้อมูลที่แม่นยำรอบคอบ ใช้ข้อมูลเพื่อเพิ่มประสิทธิภาพกระบวนการผลิต',
                    INTP: 'นักคิดเชิงวิเคราะห์ ชอบออกแบบและพัฒนาเทคโนโลยีใหม่ๆ เช่น IoT และ AI ในโรงงาน',
                }
            }
        ];

        // --- HELPER FUNCTIONS ---

        function showMessage(text) {
            document.getElementById('message-text').innerText = text;
            document.getElementById('message-box').classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                const text = translations[lang][key];
                if (text) {
                    if (element.hasAttribute('data-gender')) {
                        element.textContent = text;
                    } else if (key === 'progress-text') {
                        element.innerHTML = text;
                        document.getElementById('current-q').textContent = currentQuestionIndex + 1;
                    } else {
                        element.textContent = text;
                    }
                }
            });
            if (currentStep === 2) renderQuestion(currentQuestionIndex);
            if (currentStep === 3) displayResult();
            if (currentStep === 4) renderMajorDetails();

            document.querySelectorAll('.gender-button').forEach(button => {
                const genderKey = button.getAttribute('data-gender') === 'Male' ? 'gender-male' : 'gender-female';
                button.textContent = translations[lang][genderKey];
            });
        }

        function updateStep1Button() {
            userName = document.getElementById('user-name').value.trim();
            userAge = parseInt(document.getElementById('user-age').value);

            const startButton = document.getElementById('start-button');
            if (userName && userAge >= 10 && userGender) {
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function setGender(gender) {
            userGender = gender;
            document.querySelectorAll('.gender-button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'bg-pink-500', 'ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-blue-500', 'ring-pink-500');
                btn.classList.add('bg-gray-700', 'hover:bg-blue-600');
                if (btn.getAttribute('data-gender') === gender) {
                    if (gender === 'Male') {
                         btn.classList.add('bg-blue-500', 'ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-blue-500');
                         btn.classList.remove('bg-gray-700', 'hover:bg-blue-600');
                    } else {
                        btn.classList.add('bg-pink-500', 'ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-pink-500');
                        btn.classList.remove('bg-gray-700', 'hover:bg-blue-600');
                    }
                }
            });
            updateStep1Button();
        }

        // --- STEP 1: START QUIZ ---
        function startQuiz() {
            userName = document.getElementById('user-name').value.trim();
            userAge = parseInt(document.getElementById('user-age').value);

            if (!userName || userAge < 10 || !userGender) {
                showMessage(translations[currentLanguage]['alert-fill-all']);
                return;
            }

            score = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            currentQuestionIndex = 0;
            updateStep(2);
            renderQuestion(currentQuestionIndex);
        }

        // --- STEP 2: QUIZ LOGIC ---

        function renderQuestion(index) {
            const container = document.getElementById('quiz-content');
            const qData = quizQuestions[index];
            const qLang = translations[currentLanguage][qData.key];

            if (!qLang || !qLang.text || !qLang.a || !qLang.b) {
                console.error(`Missing translation data for question key: ${qData.key}`);
                return;
            }

            container.innerHTML = `
                <div class="mb-6">
                    <p class="text-xl font-semibold glowing-text mb-4 text-center">${qLang.text}</p>
                </div>
                <div class="space-y-4">
                    <button class="question-option w-full p-4 rounded-2xl bg-gray-800 border border-purple-500 text-lg text-left transition duration-300" onclick="selectAnswer('${qLang.a.score}')">
                        A. ${qLang.a.text}
                    </button>
                    <button class="question-option w-full p-4 rounded-2xl bg-gray-800 border border-purple-500 text-lg text-left transition duration-300" onclick="selectAnswer('${qLang.b.score}')">
                        B. ${qLang.b.text}
                    </button>
                </div>
            `;

            document.getElementById('current-q').textContent = index + 1;
            document.getElementById('next-q-button').disabled = true;
            document.getElementById('next-q-button').classList.add('opacity-50', 'cursor-not-allowed');
        }

        function selectAnswer(scoreKey) {
            const qData = quizQuestions[currentQuestionIndex];
            document.querySelectorAll('.question-option').forEach(btn => {
                btn.classList.remove('bg-purple-700', 'ring-4', 'ring-purple-400');
            });

            const selectedButton = event.target.closest('.question-option');
            selectedButton.classList.add('bg-purple-700', 'ring-4', 'ring-purple-400');

            qData.selectedScore = scoreKey;

            document.getElementById('next-q-button').disabled = false;
            document.getElementById('next-q-button').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function nextQuestion() {
            const selectedScoreKey = quizQuestions[currentQuestionIndex].selectedScore;
            if (!selectedScoreKey) {
                showMessage(translations[currentLanguage]['alert-select-option']);
                return;
            }

            score[selectedScoreKey] += 1;

            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                renderQuestion(currentQuestionIndex);
            } else {
                calculateMBTI();
            }
        }

        // --- STEP 3: RESULT LOGIC ---

        function calculateMBTI() {
            const e = score.E;
            const i = score.I;
            const s = score.S;
            const n = score.N;
            const t = score.T;
            const f = score.F;
            const j = score.J;
            const p = score.P;

            const finalMBTI =
                (e >= i ? 'E' : 'I') +
                (s >= n ? 'S' : 'N') +
                (t >= f ? 'T' : 'F') +
                (j >= p ? 'J' : 'P');

            document.getElementById('result-mbti').textContent = finalMBTI;
            displayResult(finalMBTI);
            updateStep(3);
        }

        function getReasonText(lang, majorId, mbti, fallbackMajorIdIfAny=null) {
            // Try specific reason for MBTI within the major
            const byMajor = translations[lang].reasoning?.[majorId];
            if (byMajor && byMajor[mbti]) return byMajor[mbti];

            // Try generic reason for the major
            const genericByMajor = translations[lang].reasoning_generic?.[majorId];
            if (genericByMajor) return genericByMajor;

            // As a last resort, use the Thai text embedded in majorData (if present)
            const major = majorData.find(m => m.id === majorId);
            if (major && major.reasoning && major.reasoning[mbti]) return major.reasoning[mbti];

            // Or fall back to description
            if (major && major.description) return major.description;

            // Or generic text from fallbackMajorIdIfAny
            if (fallbackMajorIdIfAny && translations[lang].reasoning_generic?.[fallbackMajorIdIfAny]) {
                return translations[lang].reasoning_generic[fallbackMajorIdIfAny];
            }

            return '';
        }

        function getRecommendation(mbti) {
            for (const major of majorData) {
                if (major.mbti.includes(mbti)) {
                    return {
                        majorKey: major.lang_key,
                        majorName: translations[currentLanguage][major.lang_key] || major.lang_key,
                        reason: getReasonText(currentLanguage, major.id, mbti) 
                    };
                }
            }

            // Fallbacks by MBTI traits
            if (mbti.includes('T') && mbti.includes('J')) {
                return { majorKey: 'major-eng',
                         majorName: translations[currentLanguage]['major-eng'],
                         reason: translations[currentLanguage].fallbacks.TJ };
            }
            if (mbti.includes('N') && mbti.includes('P')) {
                return { majorKey: 'major-it',
                         majorName: translations[currentLanguage]['major-it'],
                         reason: translations[currentLanguage].fallbacks.NP };
            }
            if (mbti.includes('F') && mbti.includes('E')) {
                return { majorKey: 'major-comm',
                         majorName: translations[currentLanguage]['major-comm'],
                         reason: translations[currentLanguage].fallbacks.FE };
            }

            return { majorKey: 'major-bba',
                     majorName: translations[currentLanguage]['major-bba'],
                     reason: translations[currentLanguage].fallbacks.DEFAULT_BBA };
        }

        function displayResult(mbti = document.getElementById('result-mbti').textContent) {
            const recommendation = getRecommendation(mbti);

            document.getElementById('result-major').textContent = recommendation.majorName;
            document.getElementById('result-reason').textContent = recommendation.reason;
            document.getElementById('door-label').textContent = recommendation.majorName;

            const npc = NPC_MAPPING[mbti] || NPC_MAPPING.default;
            const npcIcon = document.getElementById('npc-icon');
            const npcInfo = document.getElementById('npc-info');

            npcIcon.textContent = npc.icon;
            npcIcon.style.color = npc.color;
            npcInfo.textContent = `${userName} (${userAge}) - ${mbti}`;

            npcIcon.classList.remove('animate-bounce');
            npcIcon.style.transform = 'translateX(-100%)';
            setTimeout(() => {
                npcIcon.style.transition = 'transform 3s ease-in-out';
                npcIcon.style.transform = 'translateX(0)';
            }, 50);
            setTimeout(() => {
                npcIcon.style.transition = 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out';
                npcIcon.style.transform = 'scale(0) translateY(-50px)';
                npcIcon.style.opacity = '0';
                setTimeout(() => {
                    npcIcon.style.transition = 'none';
                    npcIcon.style.transform = 'scale(1) translateY(0) translateX(-100%)';
                    npcIcon.style.opacity = '1';
                }, 3500);
            }, 3000);
        }

        // --- STEP 4: DETAILS LOOKUP ---

        function renderMajorDetails() {
            const listContainer = document.getElementById('major-list');
            listContainer.innerHTML = '';

            majorData.forEach(major => {
                const majorTitle = translations[currentLanguage][major.lang_key];
                const emojis = ['🌟', '✨', '💡', '🧠', '⚙️', '📈', '💬', '💻'];
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];

                const description = (translations[currentLanguage].major_desc && translations[currentLanguage].major_desc[major.id]) 
                                    ? translations[currentLanguage].major_desc[major.id]
                                    : major.description;

                let mbtiListHtml = major.mbti.map(mbti => {
                    const reason = getReasonText(currentLanguage, major.id, mbti) || '';
                    return `
                        <div class="p-3 rounded-lg bg-gray-900 border border-indigo-600 mb-2">
                            <span class="font-bold text-lg text-yellow-300">${mbti}</span>: <span class="text-gray-300">${reason}</span>
                        </div>
                    `;
                }).join('');

                listContainer.innerHTML += `
                    <div class="candy-card p-6 rounded-2xl">
                        <h3 class="text-2xl font-bold glowing-text mb-3 flex items-center">
                            ${randomEmoji} ${majorTitle}
                        </h3>
                        <p class="text-lg italic text-blue-300 mb-4">${description}</p>
                        <div class="space-y-2">
                            ${mbtiListHtml}
                        </div>
                    </div>`;
            });
        }

        function showMajorDetails() {
            renderMajorDetails();
            updateStep(4);
        }

        // --- UI MANAGEMENT ---

        function updateStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(`step-${step}`).classList.remove('hidden');

            document.getElementById('main-card').scrollTop = 0;
        }

        function resetApp() {
            currentStep = 1;
            userName = '';
            userAge = 0;
            userGender = '';
            currentQuestionIndex = 0;
            score = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            quizQuestions.forEach(q => q.selectedScore = undefined);

            document.getElementById('user-name').value = '';
            document.getElementById('user-age').value = '';
            document.querySelectorAll('.gender-button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'bg-pink-500', 'ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-blue-500', 'ring-pink-500');
                btn.classList.add('bg-gray-700', 'hover:bg-blue-600');
            });
            updateStep1Button();
            updateStep(1);
        }

        // --- THREE.JS INITIALIZATION & ANIMATION (Fantasy/Sci-fi Theme) ---

        function initThreeJS() {
            const canvas = document.getElementById('three-canvas');
            const width = window.innerWidth;
            const height = window.innerHeight;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setClearColor(0x0e0e1a, 1); // Dark Night/Space color

            camera.position.z = 5;

            scene.add(new THREE.AmbientLight(0x404040, 5));

            const pointLight = new THREE.PointLight(0x93c5fd, 10, 500);
            pointLight.position.set(10, 10, 10);
            scene.add(pointLight);

            const particleGeometry = new THREE.BufferGeometry();
            const particleCount = 2000;
            const posArray = new Float32Array(particleCount * 3);

            for (let i = 0; i < particleCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 100;
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particleMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.05,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true
            });
            const particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);

            const numObjects = 15;
            const geometry = new THREE.IcosahedronGeometry(0.5, 0);
            const material = new THREE.MeshStandardMaterial({
                color: 0x8a2be2,
                emissive: 0x93c5fd,
                emissiveIntensity: 0.5,
                metalness: 0.5,
                roughness: 0.1,
                transparent: true,
                opacity: 0.8
            });

            for (let i = 0; i < numObjects; i++) {
                const candy = new THREE.Mesh(geometry, material.clone());
                candy.position.set(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                );
                candy.rotation.set(
                    Math.random() * Math.PI,
                    Math.random() * Math.PI,
                    Math.random() * Math.PI
                );
                candy.userData.speedX = (Math.random() - 0.5) * 0.005;
                candy.userData.speedY = (Math.random() - 0.5) * 0.005;
                candy.userData.speedZ = (Math.random() - 0.5) * 0.005;
                scene.add(candy);
                magicObjects.push(candy);
            }

            const animate = () => {
                requestAnimationFrame(animate);

                const time = Date.now() * 0.00005;
                camera.position.x += (0 - camera.position.x) * 0.0005;
                camera.position.y += (0 - camera.position.y) * 0.0005;

                magicObjects.forEach(obj => {
                    obj.rotation.x += obj.userData.speedX;
                    obj.rotation.y += obj.userData.speedY;
                    obj.position.y += Math.sin(time * 5 + obj.id) * 0.001;
                    if (obj.position.z > 10) obj.position.z = -10;
                    if (obj.position.z < -10) obj.position.z = 10;
                });

                particles.rotation.y += 0.0005;

                renderer.render(scene, camera);
            };

            animate();

            window.addEventListener('resize', () => {
                const newWidth = window.innerWidth;
                const newHeight = window.innerHeight;
                camera.aspect = newWidth / newHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(newWidth, newHeight);
            });
        }

        // --- EVENT LISTENERS & INITIALIZATION ---

        window.onload = function () {
            initThreeJS();

            setLanguage('th');

            document.getElementById('user-name').addEventListener('input', updateStep1Button);
            document.getElementById('user-age').addEventListener('input', updateStep1Button);

            updateStep(1);
        };

        // --- NEW SHARE FUNCTIONALITY ---
function showSharePopup(dataURL) {
    const previewImg = document.getElementById('screenshot-preview');
    const igButton = document.getElementById('ig-story-share-button');
    const fbButton = document.getElementById('fb-share-button');
    const sharePopup = document.getElementById('share-popup');

    previewImg.src = dataURL;

    igButton.onclick = async (e) => {
        e.preventDefault();
        const response = await fetch(dataURL);
        const blob = await response.blob();
        const file = new File([blob], "mbti-result.png", { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: "MBTI Result",
                text: "นี่คือผลลัพธ์ MBTI ของฉัน!"
            });
        } else {
            alert("เบราว์เซอร์/แอปนี้ยังไม่รองรับการแชร์รูปไป Instagram โดยตรง\\nกรุณาบันทึกรูปแล้วอัปโหลดเองครับ");
        }
    };

    fbButton.onclick = (e) => {
        e.preventDefault();
        const downloadLink = document.createElement('a');
        downloadLink.href = dataURL;
        downloadLink.download = `MBTIxMajor_Result_${document.getElementById('result-mbti').textContent}.png`;
        downloadLink.click();
    };

    sharePopup.classList.remove('hidden');

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (!isMobile) {
        const downloadLink = document.createElement('a');
        downloadLink.href = dataURL;
        downloadLink.download = `MBTIxMajor_Result_${document.getElementById('result-mbti').textContent}.png`;
        downloadLink.textContent = 'ดาวน์โหลดรูปภาพ (สำหรับ Desktop)';
        downloadLink.classList.add('candy-button', 'w-full', 'p-3', 'rounded-full', 'text-lg', 'font-bold', 'bg-sky-600', 'hover:bg-sky-700', 'mt-3');
        const previewContainer = document.getElementById('screenshot-preview-container');
        previewContainer.appendChild(downloadLink);
    }
}

function hideSharePopup() {
    const sharePopup = document.getElementById('share-popup');
    sharePopup.classList.add('hidden');
    const downloadLink = document.querySelector('#screenshot-preview-container a');
    if (downloadLink) {
        downloadLink.remove();
    }
}
        
function shareResult() {
    const elementsToHide = document.querySelectorAll('video, #detailbt, #sharebt');
    elementsToHide.forEach(el => el.style.display = 'none');

    const elementToCapture = document.getElementById('main-card'); 

    html2canvas(elementToCapture, {
        backgroundColor: null,
        scale: 2
    }).then(canvas => {
        elementsToHide.forEach(el => el.style.display = '');

        const dataURL = canvas.toDataURL('image/png');

        showSharePopup(dataURL);
    });
}


    </script>
</body>
</html>
